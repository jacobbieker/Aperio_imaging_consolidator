# Aperio Imaging Consolidator
 Designed and developed by Patrick Leyshock (leyshock@ohsu.edu) and Jacob Bieker (jacob@bieker.us)

 Script consolidates multiple .xls files (generated by Aperio image-analysis software) into one .xlsx workbook
   Input to script is multiple .xls files.  There is one .xls file per slide, ith one or more rows, each row
     corresponding to a region selected in the image

   Output is a single .xlsx worksheet
 Assumptions:
   1.  script is located in same directory as input files
   3.  input .xls files follow this naming convention:
       (Initials-Of-Researcher)4.X M(Mouse Numer) (Mouse SID) (Stain).xls
       E.g. "JB6.3 M3 22341 BrdU.xls""

#   HOW TO USE
There are a few ways to use this script. 

Pre-requisites: R 3.1.0 or higher is installed on the computer being used, along with Perl 2.10.0 or higher
                Internet connection to install required libraries if they are not already installed

For Windows users: 

1. Download config.yml and aperio_consolidator.bat to your computer. 
2. Move all the .xls files from Aperio into one folder, renamed to follow the
above format
3. Set the Perl location in the SETUP section of aperio_consolidator.bat to the path to perl.exe, default is 'C:/strawberry/perl/bin/perl.exe', the default install directory for strawberry Perl
4. Place config and aperio_consolidator in the same folder as in the previous step
![Screenshot](/Doc_images/Aperio_Docs_Shot_1.PNG?token=AG1pN3f-rvsUCmKCnwPYqoiNE0rIdjHjks5VrpaHwA%3D%3D)
5. If necessary, change the names of the columns in config.yml by opening it up in a text editor
6. Double click on aperio_consolidator.bat to run the program
![Screenshot](/Doc_images/Aperio_Docs_Shot_2.PNG?token=AG1pNxlT7NWzM8xUqpzf2fYxQW-Lxt1Uks5VrpbFwA%3D%3D)
7. A file called "consolidated_files.xlsx" should be created in the same folder, it contains the output of this script
![Screenshot](/Doc_images/Aperio_Docs_Shot_3.PNG?token=AG1pNzhYwTZkB68-6ZWCcYn3rnEW2quJks5Vrpb9wA%3D%3D)


For Mac OSX/Linux users:

1. Download config.yml and aperio_consolidator.sh to your computer. 
2. Move all the .xls files from Aperio into one folder, renamed to follow the
above format
3. Set the Perl location in SETUP section of aperio_consolidator.sh to the path to the perl executable, default is 'usr/bin/perl'
4. Place config and aperio_consolidator in the same folder as in the previous step
5. If necessary, change the names of the columns in config.yml by opening it up in a text editor
6. Double click on aperio_consolidator.sh to run the program
7. A file called "consolidated_files.xlsx" should be created in the same folder, it contains the output of this script

# Troubleshooting
On Mac OSX, sometimes R will give errors if the .sh file is run. One way around that is to open the included AppleScript template, and put in the paths to the correct files and directory, and run the program from the AppleScript script. Recommended way would be to save it as a .app file, so it can be double clicked to be executed.

Perl not found: on Mac OSX and Linux, if the perl executable is not found, from the terminal run <code>which -a perl</code> to list different executables, choose one, and put that location in the R script.

# Testing

To test this program, open the testing subfolder. If necessary, edit the testConfig.yml file to change the testing
parameters. 

Run test.py to create dummy test files based off any input file. 

Currently has to be to manually checked against expected files (stored in expected)

Cases currently covered: 
- Large sets (>4000) of files
- Missing stain name -> Throws error with the file name
